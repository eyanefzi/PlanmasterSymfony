<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>{% block title %}Planmaster{% endblock %}</title>

    <!-- Favicon -->
    <link href="{{ asset('assets/img/favicon.ico') }}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <!-- You can add more icon stylesheets here if needed -->

    <!-- Customized Bootstrap Stylesheet -->
    <link href="{{ asset('assets/css/bootstrap.min.css') }}" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="{{ asset('assets/css/styles.css') }}" rel="stylesheet" />

    {% block stylesheets %}
    <!-- Additional custom stylesheets can be added here -->
    <link href="{{ asset('assets/css/custom.css') }}" rel="stylesheet" />
    {% endblock %}
        <script src="https://js.stripe.com/v3/"></script>

</head>

<body>

    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="#">Planmaster</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="#!">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="#!">À propos</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Magasin</a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!">Tous les produits</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="#!">Produits populaires</a></li>
                            <li><a class="dropdown-item" href="#!">Nouveautés</a></li>
                        </ul>
                    </li>
                </ul>

                <!-- Cart Icon and Dropdown -->
               <div id="cart-icon" class="position-relative">
                    <button class="btn btn-outline-dark" onclick="toggleCartDropdown()">
                        <i class="fas fa-shopping-cart"></i> Panier 
                        <span id="cart-count" class="badge bg-danger">0</span>
                    </button>

                  <div id="cart-dropdown" class="dropdown-menu p-3" style="display: none; width: 300px;">
                        <div id="cart-items-list">
                            <p class="text-muted">Votre panier est vide.</p>
                        </div>
                       <button class="btn btn-success w-100 mt-2" onclick="checkout()">
                            Payer
                        </button>

                  </div>
                </div>

            </div>
        </div>
    </nav>

    <!-- Header-->
    <header class="bg-dark py-5">
        <div class="container px-4 px-lg-5 my-5">
            <div class="text-center text-white">
                <h6 class="display-4 fw-bolder">Achetez ce que vous voulez sur Planmaster !</h6>
                <p class="lead fw-normal text-white-50 mb-0"></p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        {% block body %}{% endblock %}
    </main>

    <!-- Footer-->
    <footer class="py-5 bg-dark">
        <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; Planmaster {{ "now"|date("Y") }}</p>
        </div>
    </footer>

    <!-- Bootstrap JS-->
    <script src="{{ asset('assets/js/bootstrap.bundle.min.js') }}"></script>

    <!-- Custom JS -->
    <script src="{{ asset('assets/js/scripts.js') }}"></script>

    {% block javascripts %}
    <!-- Additional custom JavaScript files can be added here -->
    {% endblock %}

    <script>
        // Function to update the cart count dynamically
        function updateCartInfo(cartCount) {
            document.getElementById('cart-count').innerText = cartCount; // Update the cart count dynamically
        }

        // Call this function on page load to initialize the cart count
        function updateCartCount() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let cartCount = cart.length; // Get the total number of products in the cart
            updateCartInfo(cartCount);  // Update the cart icon with the correct count
        }

        // Trigger this function on cart interactions (e.g., adding products to the cart)
        updateCartInfo();  // This will update the cart count when the page loads

        // Function to toggle cart dropdown visibility
        function toggleCartDropdown() {
            let dropdown = document.getElementById('cart-dropdown');
            dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
            displayCartItems();
        }

        // Function to display cart items inside the dropdown
        function displayCartItems() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let html = '<ul class="list-group list-group-flush">';
            let total = 0;

            if (cart.length === 0) {
                html += '<li class="list-group-item text-center">Votre panier est vide</li>';
            } else {
                cart.forEach(item => {
                    let subtotal = item.price * item.quantity;
                    total += subtotal;
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="me-2">
                                <strong>${item.name}</strong><br>
                                <small>${item.quantity} × DT ${item.price.toFixed(2)} = <strong>DT ${subtotal.toFixed(2)}</strong></small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.productId})">
                                &times;
                            </button>
                        </li>`;
                });
            }

            html += '</ul>';
            document.getElementById('cart-items-list').innerHTML = html;
            document.getElementById('cart-total').innerText = 'Total : DT ' + total.toFixed(2);
        }

        // Function to add product to cart
        function addToCart(productId, price, name) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let product = cart.find(item => item.productId === productId);

            if (product) {
                product.quantity += 1;
            } else {
                cart.push({ productId, name, price, quantity: 1 });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            displayCartItems();
        }

        // Function to remove product from cart
        function removeFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart = cart.filter(item => item.productId !== productId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            displayCartItems();
        }

        // Update the cart count when page loads
        document.addEventListener("DOMContentLoaded", function () {
            updateCartCount();
        });
function checkout() {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    if (cart.length === 0) {
        alert('Votre panier est vide !');
        return;
    }

    let total = 0;
    cart.forEach(item => {
        total += item.price * item.quantity;
    });

    fetch('/create-checkout-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            totalAmount: Math.round(total * 100)
        })
    })
    .then(response => response.json())
    .then(session => {    console.log('Session Stripe reçue:', session); // Ajoute ça


        const stripe = Stripe('pk_test_51RBMki4NCECvuRy85Ev8DO6gdHf7QFBSi2pkSwpPS5mjcuQjxqDjnRuw3jeB0nfvfxkMD8HWrc9jkV79nmJgpm5l00RojlUKNH');
        return stripe.redirectToCheckout({ sessionId: session.id });
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
}


    </script>
</body>

</html>
